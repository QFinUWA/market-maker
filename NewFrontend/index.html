<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>QFIN Orderbooks</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="lib/signalr/signalr.js"></script>
    </head>
    <body
        class="flex h-screen flex-col items-center justify-center bg-gray-100"
    >
        <script>
            /**
             * @typedef {Object} Exchange
             * @property {Array<string>} markets - Array of market strings.
             * @property {Array<string>} participants - Array of participant strings.
             * @enum {"Lobby" | "Open" | "Closed" | "Paused"} state - Current state of the exchange.
             * @property {string} exchangeName - Name of the exchange.
             * @property {string} exchangeCode - Code of the exchange.
             */

            /**
             * @type {Exchange | undefined} exchange
             */
            let exchange = {
                markets: {}, // dictionary of market codes to dictionary of orders and transactions
                participants: [],
                state: "Lobby",
                exchangeName: "",
                exchangeCode: "",
            };

            //setInterval(() => {
            //    console.log(exchange);
            //}, 1000)

            // TODO: convert to using exchange object
            // TODO: create UI for exchange
            // TODO: its not connecting to the server for some reason? (changes in the server aren't triggering the client)

            const serverURL = "https://market-maker.azurewebsites.net/";
            function bindConnection(jwt) {
                // Thank you Isaac
                // Called when creating a exchange or joining an exchange
                const connection = new signalR.HubConnectionBuilder()
                    .withUrl(serverURL + "exchange", {
                        skipNegotiation: true,
                        transport: signalR.HttpTransportType.WebSockets,
                        accessTokenFactory: () => jwt,
                    })
                    // .configureLogging(signalR.LogLevel.Debug)
                    .build();

                async function start() {
                    try {
                        await connection.start();
                        console.log("SignalR Connected.");
                    } catch (err) {
                        console.log(err);
                        // setTimeout(start, 50000000);
                    }
                }

                connection.onclose(async () => {
                    await start();
                });

                connection.on("ReceiveMessage", (message) => {
                    console.log("server: " + message);
                });

                connection.on("ExchangeState", (exchangeResponse) => {
                    exchangeResponse.orders.forEach((order) => {
                        exchange.markets[order.market].orders.push(order);
                    });
                    exchangeResponse.transactions.forEach((transaction) => {
                        exchange.markets[transaction.market].transactions.push(transaction);
                    });
                    console.log("ExchangeState", exchangeResponse, exchange);
                });

                connection.on("StateUpdated", (newState) => {
                    exchange.state = newState;
                    console.log("StateUpdated", exchange);
                });

                connection.on("LobbyState", (message) => {
                    // for each market, add an empty list to the dictionary
                    message.markets.forEach((market) => {
                        exchange.markets[market[0]] = {"orders": [], "transactions": []}; // each market is a list for some reason
                    });

                    exchange.participants = message.participants;
                    exchange.exchangeName = message.exchangeName;
                    exchange.exchangeCode = message.exchangeCode;
                    exchange.state = message.state;
                    console.log("LobbyState", message, exchange);
                });

                connection.on("NewOrder", (order) => {
                    exchange.markets[order.market].orders.push(order);
                    console.log("NewOrder", order, exchange);
                });

                connection.on("DeletedOrder", (orderID) => {
                    console.log("DeletedOrder", orderID);
                    //delete orders[orderID];
                    //refreshExchange();
                });

                connection.on("NewParticipant", (user) => {
                    exchange.participants.push(user);
                    console.log("NewParticipant", user, exchange);
                });

                function updateOrRemove(id, quantity) {
                    //orders[id]["quantity"] += quantity;
                    //if (orders[id]["quantity"] == 0) {
                    //    delete orders[id];
                    //}
                }

                connection.on("OrderReceived", (orderList) => { // TODO it seems like this route never runs
                    console.log("OrderReceived", orderList);
                    //transactions.push(formatTransaction(transactionEvent));

                    //updateOrRemove(
                    //    transactionEvent["buyerOrderId"],
                    //    -transactionEvent["quantity"],
                    //);
                    //updateOrRemove(
                    //    transactionEvent["sellerOrderId"],
                    //    transactionEvent["quantity"],
                    //);
                    //refreshExchange();
                });

                connection.on("ClosingPrices", (closingPrices) => {
                    console.log("ClosingPrices", closingPrices);
                });

                return [connection, start];
            }

            // joinExchange needs to be run once on load to set your name and join
            // just a button to join 
            function joinExchange(name) {
                connection.invoke("JoinExchange", name).catch((err) => {
                    console.error(err.toString());
                });
            }

            // On load, checks if a jwt token is present in cookies
            // If not, redirect to login page
            if (document.cookie.indexOf("jwt") == -1) {
                window.location.href = "login.html";
            }
            const jwt = document.cookie
                .split(";")
                .find((c) => c.trim().startsWith("jwt="))
                .split("=")[1];

            // Connect to the SignalR hub
            const [connection, start] = bindConnection(jwt);
            start()
            
        </script>
    </body>
</html>
