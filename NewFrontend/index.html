<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>QFIN Orderbooks</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="lib/signalr/signalr.js"></script>
    </head>
    <body class="bg-gray-300 w-full">
            <nav class="bg-white shadow px-4 flex justify-between items-center h-[6vh]">
                <div class="flex space-x-6">
                    <h1 id="exchangeName">[Exchange Name]</h1>
                    <h1 id="exchangeCode" class="text-slate-500" >[Exchange Code]</h1>
                </div>
                <div class="flex space-x-6">
                    <h1 id="playerName">[Name]</h1>
                    <h1 id="exchangeState">[State]</h1>
                </div>
            </nav>

            <div class="mx-auto w-[96vw] mt-[1vh] h-[90vh] shadow-lg">
                <div id="tab-navigation" class="flex h-[4%] min-h-[26px]">
                </div>
            
                <div id="tab-content" class=" h-[96%] w-full">
                
                </div>
            </div>


        <script>

            let exchange = {
                markets: {}, // dictionary of market codes to dictionary of orders and transactions
                participants: [],
                state: "Lobby",
                exchangeName: "",
                exchangeCode: "",
            };

            const serverURL = "https://market-maker.azurewebsites.net/";
        
            marketToTabID = {} // used to identify the content tab ID for a given market (to use for populating the tab content)

            let transaction_cols = ["Price", "Quantity", "Buyer", "Seller", "Aggressive", "Passive"];
            let filter_ranges = {};
            for(let col of transaction_cols){
                filter_ranges[col] = ["", ""];
            }

            function initOrderInput(){
                Object.keys(exchange.markets).forEach((marketKey) => {
                    let d = document.getElementById(`orderInput-${marketToTabID[marketKey]}`);
                    d.innerHTML='';
                    d.classList.add("w-2/3", "min-h-[50%]", "flex", "gap-[2%]");

                    bidDiv = document.createElement("div");
                    bidDiv.classList.add("h-[100px]", "w-[49%]", "border", "border-black");

                    bidPriceInput = document.createElement("input");
                    bidPriceInput.classList.add("h-[50%]", "w-[50%]", "text-center", "text-md");
                    bidPriceInput.type = "number";
                    bidPriceInput.placeholder = "Price";
                    bidPriceInput.id = `bidPriceInput-${marketToTabID[marketKey]}`;

                    bidQuantityInput = document.createElement("input");
                    bidQuantityInput.classList.add("h-[50%]", "w-[50%]", "text-center", "text-md");
                    bidQuantityInput.type = "number";
                    bidQuantityInput.placeholder = "Quantity";
                    bidQuantityInput.id = `bidQuantityInput-${marketToTabID[marketKey]}`;
                    
                    bidButtonDiv = document.createElement("div");
                    bidButtonDiv.classList.add("h-[50%]", "w-[100%]", "flex", "justify-center", "items-center");

                    bidButton = document.createElement("button");
                    bidButton.classList.add("h-[70%]", "w-[70%]", "text-center", "text-sm", "font-medium", "bg-green-600", "hover:bg-green-700", "text-white", "rounded-md");
                    bidButton.innerHTML = "Send Bid";
                    bidButton.id = `bidButton-${marketToTabID[marketKey]}`;
                    bidButton.addEventListener("click", function(event){
                        let price = document.getElementById(`bidPriceInput-${marketToTabID[marketKey]}`).value;
                        let quantity = document.getElementById(`bidQuantityInput-${marketToTabID[marketKey]}`).value;
                        console.log(`Send bid of ${price} @ ${quantity}`);
                        connection
                            .invoke("PlaceOrder", marketKey, parseInt(price), parseInt(quantity), "ref")
                            .catch((err) => console.error(err.toString()));
                    });

                    askDiv = document.createElement("div");
                    askDiv.classList.add("h-[100px]", "w-[49%]", "border", "border-black");

                    askPriceInput = document.createElement("input");
                    askPriceInput.classList.add("h-[50%]", "w-[50%]", "text-center", "text-md");
                    askPriceInput.type = "number";
                    askPriceInput.placeholder = "Price";
                    askPriceInput.id = `askPriceInput-${marketToTabID[marketKey]}`;

                    askQuantityInput = document.createElement("input");
                    askQuantityInput.classList.add("h-[50%]", "w-[50%]", "text-center", "text-md");
                    askQuantityInput.type = "number";
                    askQuantityInput.placeholder = "Quantity";
                    askQuantityInput.id = `askQuantityInput-${marketToTabID[marketKey]}`;

                    askButtonDiv = document.createElement("div");
                    askButtonDiv.classList.add("h-[50%]", "w-[100%]", "flex", "justify-center", "items-center");

                    askButton = document.createElement("button");
                    askButton.classList.add("h-[70%]", "w-[70%]", "text-center", "text-sm", "font-medium", "bg-red-600", "hover:bg-red-800", "text-white", "rounded-md");
                    askButton.innerHTML = "Send Ask";
                    askButton.id = `askButton-${marketToTabID[marketKey]}`;
                    askButton.addEventListener("click", function(event){
                        let price = document.getElementById(`askPriceInput-${marketToTabID[marketKey]}`).value;
                        let quantity = document.getElementById(`askQuantityInput-${marketToTabID[marketKey]}`).value;
                        console.log(`Send ask of ${price} @ ${quantity}`);
                        connection
                            .invoke("PlaceOrder", marketKey, parseInt(price), -parseInt(quantity), "ref")
                            .catch((err) => console.error(err.toString()));
                    });

                    bidDiv.appendChild(bidPriceInput);
                    bidDiv.appendChild(bidQuantityInput);
                    bidDiv.appendChild(bidButtonDiv);
                    bidButtonDiv.appendChild(bidButton);
                    askDiv.appendChild(askPriceInput);
                    askDiv.appendChild(askQuantityInput);
                    askDiv.appendChild(askButtonDiv);
                    askButtonDiv.appendChild(askButton);
                    d.appendChild(bidDiv);
                    d.appendChild(askDiv);

                });
            }
            
            function initTransactionTable(){
                document.getElementById("exchangeName").textContent = exchange.exchangeName;
                document.getElementById("exchangeCode").textContent = exchange.exchangeCode;
                document.getElementById("exchangeState").textContent = exchange.state;
                // console.log(exchange.markets);

                // update transactions
                Object.keys(exchange.markets).forEach((marketKey) => {
                    // console.log(marketKey);
                    let table = document.getElementById(`transactions-${marketToTabID[marketKey]}`);
                    table.innerHTML = ''; // erase existing content
                    table.classList.add("w-full");
                    let thead = table.createTHead();
                    thead.classList.add("sticky", "top-0");
                    let header = thead.insertRow();
                    
                    for (let col of transaction_cols) {
                        let cell = header.insertCell();
                        cell.outerHTML = `<th>${col}</th>`;
                        cell.textContent = col;
                    }
                    header.classList.add("[&>*]:px-2", "bg-gray-200");

                    let border = thead.insertRow();
                    border.classList.add();
                    cell = document.createElement("th");
                    cell.colSpan = 6;
                    cell.classList.add("h-[2px]", "bg-gray-500");
                    border.appendChild(cell);

                    tbody = table.createTBody();

                    let filters = tbody.insertRow();
                    for (let col of transaction_cols) {
                        let cell = filters.insertCell();    
                        
                        let select = document.createElement("select");
                        options = ["", "="];
                        if (col == "Price" || col == "Quantity"){
                            options.push("≥");
                            options.push("≤");
                        }
                        for (let option of options){
                            let opt = document.createElement("option");
                            opt.value = option;
                            opt.text = option;
                            select.appendChild(opt);
                        }
                        select.style.width = "35px";
                        select.style.display = "inline-block";
                        // select.classList.add("filter-select");
                        select.id = `filter-select-${col}`;
                        select.addEventListener("change", function(event){
                            filter_ranges[col][0] = event.target.value;
                            updateContent();
                        });

                        let input = document.createElement("input");
                        if(col == "Price" || col == "Quantity"){
                            input.type = "number";
                        }else{
                            input.type = "text";
                        }
                        input.placeholder = col; 
                        input.style.width = "calc(100% - 35px)";
                        input.style.display = "inline-block";
                        // input.classList.add("filter-input");
                        input.id = `filter-input-${col}`;
                        input.addEventListener("input", function(event){
                            if(col == "Price" || col == "Quantity"){
                                filter_ranges[col][1] = Math.round(parseFloat(event.target.value));
                            }else{
                                filter_ranges[col][1] = event.target.value;
                            }
                            updateContent();
                        });

                        cell.appendChild(select);
                        cell.appendChild(input);
                    }
                    updateContent();
                });
            }

            // updates all the content on the page
            function updateContent() {

                // // update transactions
                Object.keys(exchange.markets).forEach((marketKey) => {
                    let table = document.getElementById(`transactions-${marketToTabID[marketKey]}`);
                    if(table.getElementsByTagName("tbody").length > 0){
                        tbody = table.tBodies[0];
                        for (let i = tbody.rows.length - 1; i > 0; i--) {
                            tbody.deleteRow(i);
                        }
                    }
                
                    Object.keys(exchange.markets[marketKey].transactions).forEach((transactionKey) => {
                        // console.log(transactionKey);
                        let transaction = exchange.markets[marketKey].transactions[transactionKey];
                        let passive = transaction.sellerUser;
                        let aggressive = transaction.buyerUser;
                        if(transaction.passiveOrder == transaction.buyerOrderId){
                            passive = transaction.buyerUser;
                            aggressive = transaction.sellerUser;
                        }
                        transaction_dict = {
                            "Price": transaction.price,
                            "Quantity": transaction.quantity,
                            "Buyer": transaction.buyerUser,
                            "Seller": transaction.sellerUser,
                            "Aggressive": aggressive,
                            "Passive": passive
                        }
                        
                        
                        let reject = false;
                        let row = document.createElement("tr");
                        Object.keys(transaction_dict).forEach((col) => {
                            if(filter_ranges[col][0] != "" && filter_ranges[col][1] != ""){
                                if(filter_ranges[col][0] == "=" && transaction_dict[col] != filter_ranges[col][1]){
                                    reject = true;
                                }
                                if(filter_ranges[col][0] == "≥" && transaction_dict[col] < filter_ranges[col][1]){
                                    reject = true;
                                }
                                if(filter_ranges[col][0] == "≤" && transaction_dict[col] > filter_ranges[col][1]){
                                    reject = true;
                                }
                            }
                            let cell = row.insertCell();
                            cell.textContent = transaction_dict[col];
                        });
                        if(!reject){
                            tbody.appendChild(row);
                        }
                        row.classList.add("border-b-2", "border-gray-300", "[&>*]:px-2");
                    });

                });

                // update orders
                Object.keys(exchange.markets).forEach((marketKey) => {
                    // console.log(marketKey);
                    let table = document.getElementById(`orders-${marketToTabID[marketKey]}`);
                    table.innerHTML = ''; // erase existing content
                    table.classList.add("w-full");
                    let thead = table.createTHead();
                    thead.classList.add("sticky", "top-0");
                    let header = thead.insertRow();
                    for (let col of ["Bidder", "Quantity", "Price", "Quantity", "Asker"]) {
                        let cell = header.insertCell();
                        cell.outerHTML = `<th>${col}</th>`;
                        cell.textContent = col;
                    }
                    header.classList.add("[&>*]:px-2", "bg-gray-200");

                    let border = thead.insertRow();
                    border.classList.add();
                    cell = document.createElement("th");
                    cell.colSpan = 6;
                    cell.classList.add("h-[2px]", "bg-gray-500");
                    border.appendChild(cell);

                    tbody = table.createTBody();

                    // add the orders

                    let minPrice = Math.min(...exchange.markets[marketKey].orders.map((o) => o.price));
                    let maxPrice = Math.max(...exchange.markets[marketKey].orders.map((o) => o.price));

                    for (let price = maxPrice; price >= minPrice; price--) {
                        let ordersAtPrice = exchange.markets[marketKey].orders.filter((o) => o.price == price);
                        for (let order of ordersAtPrice) {
                            let row = tbody.insertRow();
                            let cell = row.insertCell();
                            cell.textContent = order.quantity > 0 ? order.user : "";
                            cell = row.insertCell();
                            cell.textContent = order.quantity > 0 ? order.quantity : "";
                            cell = row.insertCell();
                            cell.textContent = order.price;
                            cell = row.insertCell();
                            cell.textContent = order.quantity < 0 ? - order.quantity  : "";
                            cell = row.insertCell();
                            cell.textContent = order.quantity < 0 ? order.user : "";
                            row.classList.add("border-b-2", "border-gray-300", "[&>*]:px-2");
                        }
                    }

                });
            }
            

            // generates the tabs for each market (should run every time markets change)
            function generateTabs(tabNames) {
                const tabNavigation = document.getElementById('tab-navigation');
                const tabContent = document.getElementById('tab-content');

                const activeTabColor = "bg-gray-200";
                const inactiveTabColor = "bg-gray-100";
                // Clear existing tabs and content
                tabNavigation.innerHTML = '';
                tabContent.innerHTML = '';
                
                marketToTabID = tabNames.reduce((acc, name, index) => {
                    acc[name] = index; // create a dictionary of market names to tab content IDs
                    return acc;
                }, {});
                // Create tabs and content dynamically
                tabNames.forEach((name, index) => {
                    const tabId = `tab-${index}`;
                    const contentId = `content-${index}`;

                    // Create tab element
                    const tab = document.createElement('div');
                    tab.id = tabId;
                    tab.classList.add('tab', inactiveTabColor, 'hover:'+activeTabColor, 'px-4', 'rounded-t-md', 'cursor-pointer');
                    tab.textContent = name;
                    tabNavigation.appendChild(tab);

                    // Create content element
                    const content = document.createElement('div');
                    content.id = contentId;
                    content.classList.add('p-4', 'bg-gray-200', 'hidden', 'h-full', 'flex', 'rounded-br-lg', 'rounded-bl-lg', 'rounded-tr-lg');

                    const leftSide = document.createElement('div');
                    leftSide.classList.add('w-1/2', 'h-full', 'pl-2', "pr-4", "overflow-y-auto");

                    const orderTable = document.createElement('table');
                    orderTable.id = `orders-${index}`;

                    leftSide.appendChild(orderTable);

                    const rightSide = document.createElement('div');
                    rightSide.classList.add('w-1/2', 'h-full', "pr-2", "pl-4");

                    const topRightSide = document.createElement('div');
                    topRightSide.classList.add('w-full', 'h-1/2', "overflow-y-auto");

                    const bottomRightSide = document.createElement('div');
                    bottomRightSide.classList.add('w-full', 'h-1/2', "overflow-y-auto");

                    const orderInput = document.createElement('div');
                    orderInput.id = `orderInput-${index}`;

                    const transactionTable = document.createElement('table');
                    transactionTable.id = `transactions-${index}`;

                    topRightSide.appendChild(orderInput);
                    bottomRightSide.appendChild(transactionTable);

                    rightSide.appendChild(topRightSide);
                    rightSide.appendChild(bottomRightSide);

                    content.appendChild(leftSide);
                    content.appendChild(rightSide);

                    tabContent.appendChild(content);

                    // Click handler for tabs
                    tab.addEventListener('click', () => {
                        const allContent = document.querySelectorAll('[id^="content-"]');
                        allContent.forEach(item => item.classList.add('hidden'));
                        document.getElementById(contentId).classList.remove('hidden');
                        const allTabs = document.querySelectorAll('[id^="tab-"]');
                        allTabs.forEach(item => item.classList.remove(activeTabColor));
                        allTabs.forEach(item => item.classList.add(inactiveTabColor));
                        document.getElementById(tabId).classList.remove(inactiveTabColor);
                        document.getElementById(tabId).classList.add(activeTabColor);

                    });
                });

                // Show the first tab initially
                tabNavigation.firstChild.click();
                initOrderInput();
                initTransactionTable();
            }



            function bindConnection(jwt) {
                // Thank you Isaac
                // Called when creating a exchange or joining an exchange
                const connection = new signalR.HubConnectionBuilder()
                    .withUrl(serverURL + "exchange", {
                        skipNegotiation: true,
                        transport: signalR.HttpTransportType.WebSockets,
                        accessTokenFactory: () => jwt,
                    })
                    // .configureLogging(signalR.LogLevel.Debug)
                    .build();

                async function start() {
                    try {
                        await connection.start();
                        console.log("SignalR Connected.");
                    } catch (err) {
                        console.log(err);
                        // setTimeout(start, 50000000);
                    }
                }

                connection.onclose(async () => {
                    await start();
                });

                connection.on("ReceiveMessage", (message) => {
                    console.log("server: " + message);
                });

                connection.on("ExchangeState", (exchangeResponse) => {
                    exchangeResponse.orders.forEach((order) => {
                        exchange.markets[order.market].orders.push(order);
                    });
                    exchangeResponse.transactions.forEach((transaction) => {
                        exchange.markets[transaction.market].transactions.push(transaction);
                    });
                    console.log("ExchangeState", exchangeResponse, exchange);
                    initTransactionTable();
                });

                connection.on("StateUpdated", (newState) => {
                    exchange.state = newState;
                    console.log("StateUpdated", exchange);
                });

                connection.on("LobbyState", (message) => {
                    // for each market, add an empty list to the dictionary
                    message.markets.forEach((market) => {
                        if (!(market[0] in exchange.markets))  {
                            exchange.markets[market[0]] = {"orders": [], "transactions": []}; // each market is a list for some reason
                        }
                    });

                    exchange.participants = message.participants;
                    exchange.exchangeName = message.exchangeName;
                    exchange.exchangeCode = message.exchangeCode;
                    exchange.state = message.state;

                    generateTabs(Object.keys(exchange.markets));
                    console.log("LobbyState", message, exchange);
                });

                connection.on("NewOrder", (order) => {
                    if (order.quantity != 0) {
                        exchange.markets[order.market].orders.push(order);
                    }
                    for (const transaction of order.transactions) {
                        exchange.markets[order.market].transactions.push(transaction);

                        let passiveOrder = exchange.markets[order.market].orders.find((o) => o.id == transaction.passiveOrder);
                        console.log("passiveOrder", passiveOrder);
                        console.log("transaction", transaction);
                        passiveOrder.quantity += transaction.quantity * (passiveOrder.quantity < 0 ? 1 : -1);
                        if (passiveOrder.quantity == 0) {
                            exchange.markets[order.market].orders = exchange.markets[order.market].orders.filter((o) => o.id != passiveOrder.id);
                        }
                    }
                    console.log("NewOrder", order, exchange);
                    updateContent();
                });

                connection.on("DeletedOrder", (orderID) => {
                    console.log("DeletedOrder", orderID);
                    //delete orders[orderID];
                    //refreshExchange();
                });

                connection.on("NewParticipant", (user) => {
                    exchange.participants.push(user);
                    console.log("NewParticipant", user, exchange);
                });

                function updateOrRemove(id, quantity) {
                    //orders[id]["quantity"] += quantity;
                    //if (orders[id]["quantity"] == 0) {
                    //    delete orders[id];
                    //}
                }

                connection.on("OrderReceived", (orderList) => { // TODO it seems like this route never runs
                    console.log("OrderReceived", orderList);
                    //transactions.push(formatTransaction(transactionEvent));

                    //updateOrRemove(
                    //    transactionEvent["buyerOrderId"],
                    //    -transactionEvent["quantity"],
                    //);
                    //updateOrRemove(
                    //    transactionEvent["sellerOrderId"],
                    //    transactionEvent["quantity"],
                    //);
                    //refreshExchange();
                });

                connection.on("ClosingPrices", (closingPrices) => {
                    console.log("ClosingPrices", closingPrices);
                });

                return [connection, start];
            }

            // joinExchange needs to be run once on load to set your name and join
            // just a button to join 
            function joinExchange(name) {
                connection.invoke("JoinExchange", name).catch((err) => {
                    console.error(err.toString());
                });
            }

            console.log(document.cookie);
            // On load, checks if a jwt token is present in cookies
            // If not, redirect to login page
            if (document.cookie.indexOf("jwt") == -1) {
                window.location.href = "login.html";
            }
            const jwt = document.cookie
                .split(";")
                .find((c) => c.trim().startsWith("jwt="))
                .split("=")[1];
            const name = document.cookie
                .split(";")
                .find((c) => c.trim().startsWith("name="))
                .split("=")[1];

            document.getElementById("playerName").textContent = name;

            // Connect to the SignalR hub
            const [connection, start] = bindConnection(jwt);
            start()
            
        </script>
    </body>
</html>
