<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>QFIN Orderbooks</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="lib/signalr/signalr.js"></script>
    </head>
    <body class="">
            <nav class="bg-white shadow p-4 flex justify-between items-center">
                <div class="flex space-x-6">
                    <h1 id="exchangeName">[Exchange Name]</h1>
                    <h1 id="exchangeCode" class="text-slate-500" >[Exchange Code]</h1>
                </div>
                <div class="">[State]</div>
            </nav>

                <div class="container mx-auto p-4">
                    <div id="tab-navigation" class="flex">
                    </div>
                
                    <div id="tab-content" class="border-t-2">
                    </div>
                </div>

        <script>

            function generateTabs(tabNames) {
                const tabNavigation = document.getElementById('tab-navigation');
                const tabContent = document.getElementById('tab-content');
                // Check for unique names
                const nameSet = new Set();
                for (const name of tabNames) {
                    if (nameSet.has(name)) {
                        console.error(`Duplicate tab name found: ${name}`);
                        return; // Stop generating tabs if duplicates exist
                    }
                    nameSet.add(name);
                }

                // Clear existing tabs and content
                tabNavigation.innerHTML = '';
                tabContent.innerHTML = '';

                // Create tabs and content dynamically
                tabNames.forEach(name => {
                    const tabId = name.toLowerCase().replace(/\s+/g, '-'); // Format for IDs
                    const contentId = `content-${tabId}`;

                    // Create tab element
                    const tab = document.createElement('div');
                    tab.id = tabId;
                    tab.classList.add('tab', 'bg-gray-100', 'hover:bg-gray-200', 'px-4', 'rounded-t-md', 'cursor-pointer');
                    tab.textContent = name;
                    tabNavigation.appendChild(tab);

                    // Create content element
                    const content = document.createElement('div');
                    content.id = contentId;
                    content.classList.add('p-4', 'bg-gray-100', 'hidden');
                    tabContent.appendChild(content);

                    // Click handler for tabs
                    tab.addEventListener('click', () => {
                        const allContent = document.querySelectorAll('[id^="content-"]');
                        allContent.forEach(item => item.classList.add('hidden'));
                        document.getElementById(contentId).classList.remove('hidden');
                    });
                });

                // Show the first tab initially
                tabNavigation.firstChild.click();
            }

            // Sample usage (with a duplicate name)
            const tabNames = ["A","B","C","D"];
            generateTabs(tabNames); 


            let exchange = {
                markets: {}, // dictionary of market codes to dictionary of orders and transactions
                participants: [],
                state: "Lobby",
                exchangeName: "",
                exchangeCode: "",
            };

            const serverURL = "https://market-maker.azurewebsites.net/";
            function bindConnection(jwt) {
                // Thank you Isaac
                // Called when creating a exchange or joining an exchange
                const connection = new signalR.HubConnectionBuilder()
                    .withUrl(serverURL + "exchange", {
                        skipNegotiation: true,
                        transport: signalR.HttpTransportType.WebSockets,
                        accessTokenFactory: () => jwt,
                    })
                    // .configureLogging(signalR.LogLevel.Debug)
                    .build();

                async function start() {
                    try {
                        await connection.start();
                        console.log("SignalR Connected.");
                    } catch (err) {
                        console.log(err);
                        // setTimeout(start, 50000000);
                    }
                }

                connection.onclose(async () => {
                    await start();
                });

                connection.on("ReceiveMessage", (message) => {
                    console.log("server: " + message);
                });

                connection.on("ExchangeState", (exchangeResponse) => {
                    exchangeResponse.orders.forEach((order) => {
                        exchange.markets[order.market].orders.push(order);
                    });
                    exchangeResponse.transactions.forEach((transaction) => {
                        exchange.markets[transaction.market].transactions.push(transaction);
                    });
                    console.log("ExchangeState", exchangeResponse, exchange);
                });

                connection.on("StateUpdated", (newState) => {
                    exchange.state = newState;
                    console.log("StateUpdated", exchange);
                });

                connection.on("LobbyState", (message) => {
                    // for each market, add an empty list to the dictionary
                    message.markets.forEach((market) => {
                        exchange.markets[market[0]] = {"orders": [], "transactions": []}; // each market is a list for some reason
                    });

                    exchange.participants = message.participants;
                    exchange.exchangeName = message.exchangeName;
                    exchange.exchangeCode = message.exchangeCode;
                    exchange.state = message.state;
                    console.log("LobbyState", message, exchange);
                });

                connection.on("NewOrder", (order) => {
                    exchange.markets[order.market].orders.push(order);
                    console.log("NewOrder", order, exchange);
                });

                connection.on("DeletedOrder", (orderID) => {
                    console.log("DeletedOrder", orderID);
                    //delete orders[orderID];
                    //refreshExchange();
                });

                connection.on("NewParticipant", (user) => {
                    exchange.participants.push(user);
                    console.log("NewParticipant", user, exchange);
                });

                function updateOrRemove(id, quantity) {
                    //orders[id]["quantity"] += quantity;
                    //if (orders[id]["quantity"] == 0) {
                    //    delete orders[id];
                    //}
                }

                connection.on("OrderReceived", (orderList) => { // TODO it seems like this route never runs
                    console.log("OrderReceived", orderList);
                    //transactions.push(formatTransaction(transactionEvent));

                    //updateOrRemove(
                    //    transactionEvent["buyerOrderId"],
                    //    -transactionEvent["quantity"],
                    //);
                    //updateOrRemove(
                    //    transactionEvent["sellerOrderId"],
                    //    transactionEvent["quantity"],
                    //);
                    //refreshExchange();
                });

                connection.on("ClosingPrices", (closingPrices) => {
                    console.log("ClosingPrices", closingPrices);
                });

                return [connection, start];
            }

            // joinExchange needs to be run once on load to set your name and join
            // just a button to join 
            function joinExchange(name) {
                connection.invoke("JoinExchange", name).catch((err) => {
                    console.error(err.toString());
                });
            }

            // On load, checks if a jwt token is present in cookies
            // If not, redirect to login page
            if (document.cookie.indexOf("jwt") == -1) {
                window.location.href = "login.html";
            }
            const jwt = document.cookie
                .split(";")
                .find((c) => c.trim().startsWith("jwt="))
                .split("=")[1];

            // Connect to the SignalR hub
            const [connection, start] = bindConnection(jwt);
            start()
            
        </script>
    </body>
</html>
